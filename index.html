<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gewichtetes Haushaltseinkommen</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 2rem;
      max-width: 600px;
      margin: auto;
    }
    label, input {
      display: block;
      margin-bottom: 1rem;
      font-size: 1.1rem;
    }
    input {
      padding: 0.5rem;
      width: 100%;
      box-sizing: border-box;
    }
    button {
      padding: 0.7rem 1.2rem;
      font-size: 1rem;
      background-color: #1976d2;
      color: white;
      border: none;
      border-radius: 0.5rem;
      cursor: pointer;
    }
    #result {
      margin-top: 2rem;
      font-size: 1.2rem;
      font-weight: bold;
    }
    canvas {
      margin-top: 2rem;
    }
  </style>
</head>
<body>
  <h2>Gewichtetes Haushaltseinkommen berechnen</h2>
  <label for="adults">Anzahl der Erwachsenen (14+ Jahre):</label>
  <input type="number" id="adults" min="1" placeholder="z. B. 2" />

  <label for="children">Anzahl der Kinder (unter 14 Jahren):</label>
  <input type="number" id="children" min="0" placeholder="z. B. 1" />

  <label for="income">Jahreshaushaltseinkommen (€):</label>
  <input type="text" id="income" value="50.000" />

  <button onclick="calculateIncome()">Berechnen</button>

  <div id="result"></div>
  <canvas id="chart" width="400" height="300"></canvas>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const incomeInput = document.getElementById("income");
    const chartCanvas = document.getElementById("chart");
    let chart;
    let quartileCounts = [0, 0, 0, 0];

    // Tausendertrennzeichen live formatieren
    incomeInput.addEventListener("input", (e) => {
      const raw = e.target.value.replace(/\D/g, "");
      e.target.value = Number(raw).toLocaleString("de-DE");
    });

    function sendToGoogleSheet(weightedIncome) {
      const endpoint = "https://script.google.com/macros/s/AKfycbzRWxtGey1AqVqBaCewVbITnjvM4f5Gbc2Vt3v077GjTEe5Vrcc0Xsw3G0YvO1Ar4Sd-g/exec";

      fetch(endpoint, {
        method: "POST",
        body: JSON.stringify({
          gewichtetesEinkommen: weightedIncome
        }),
        headers: {
          "Content-Type": "application/json"
        }
      })
      .then(res => console.log("Gesendet an Google Sheets:", weightedIncome))
      .catch(err => console.error("Fehler beim Senden:", err));
    }

    function updateChart() {
      if (chart) chart.destroy();
      chart = new Chart(chartCanvas, {
        type: "bar",
        data: {
          labels: ["0–24.999", "25.000–49.999", "50.000–74.999", "75.000+"],
          datasets: [{
            label: "Anzahl der Einträge",
            data: quartileCounts,
            backgroundColor: "#1976d2"
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            title: {
              display: true,
              text: "Verteilung nach gewichtetem Einkommen (Quartile)"
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              precision: 0
            }
          }
        }
      });
    }

    function calculateIncome() {
      const adults = parseInt(document.getElementById("adults").value);
      const children = parseInt(document.getElementById("children").value);
      const incomeRaw = document.getElementById("income").value.replace(/\./g, "");
      const income = parseFloat(incomeRaw);

      if (isNaN(adults) || adults < 1 || isNaN(children) || isNaN(income)) {
        document.getElementById("result").textContent = "Bitte gültige Werte eingeben.";
        return;
      }

      const weight = 1 + (adults - 1) * 0.5 + children * 0.3;
      const weightedIncome = Math.round(income * weight / (adults + children));

      // Ergebnis anzeigen
      document.getElementById("result").textContent =
        `Dein gewichtetes Haushaltseinkommen beträgt ${weightedIncome.toLocaleString("de-DE")} €`;

      // Zählen in Quartil
      if (weightedIncome < 25000) quartileCounts[0]++;
      else if (weightedIncome < 50000) quartileCounts[1]++;
      else if (weightedIncome < 75000) quartileCounts[2]++;
      else quartileCounts[3]++;

      updateChart();
      sendToGoogleSheet(weightedIncome);
    }
  </script>
</body>
</html>
